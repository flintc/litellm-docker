# Build LiteLLM from custom fork with OAuth support
# Clones the repo during build instead of using submodule (for Portainer compatibility)

ARG LITELLM_BUILD_IMAGE=cgr.dev/chainguard/wolfi-base
ARG LITELLM_RUNTIME_IMAGE=cgr.dev/chainguard/wolfi-base
ARG LITELLM_REPO=https://github.com/flintc/litellm.git
ARG LITELLM_BRANCH=feature/claude-code-oauth-proxy-credentials

# Builder stage
FROM $LITELLM_BUILD_IMAGE AS builder

ARG LITELLM_REPO
ARG LITELLM_BRANCH

WORKDIR /app
USER root

# Install build dependencies including git
RUN apk add --no-cache bash gcc py3-pip python3 python3-dev openssl openssl-dev git

# Clone the custom litellm fork
RUN git clone --depth 1 --branch ${LITELLM_BRANCH} ${LITELLM_REPO} /app

RUN python -m pip install build

# Build Admin UI
RUN chmod +x docker/build_admin_ui.sh && ./docker/build_admin_ui.sh

# Build the package
RUN rm -rf dist/* && python -m build

# Install the package
RUN pip install dist/*.whl

# Install dependencies as wheels
RUN pip wheel --no-cache-dir --wheel-dir=/wheels/ -r requirements.txt

# Ensure pyjwt is used, not jwt
RUN pip uninstall jwt -y || true
RUN pip uninstall PyJWT -y || true
RUN pip install PyJWT==2.9.0 --no-cache-dir

# Runtime stage
FROM $LITELLM_RUNTIME_IMAGE AS runtime

ARG LITELLM_REPO
ARG LITELLM_BRANCH

USER root

# Install runtime dependencies including nodejs/npm for Claude Code
RUN apk add --no-cache bash openssl tzdata nodejs npm python3 py3-pip wget git

# Install Claude Code CLI globally
RUN npm install -g @anthropic-ai/claude-code

WORKDIR /app

# Clone again for runtime files (entrypoints, etc)
RUN git clone --depth 1 --branch ${LITELLM_BRANCH} ${LITELLM_REPO} /app

# Copy the built wheel from the builder stage
COPY --from=builder /app/dist/*.whl .
COPY --from=builder /wheels/ /wheels/

# Install the built wheel
RUN pip install *.whl /wheels/* --no-index --find-links=/wheels/ && rm -f *.whl && rm -rf /wheels

# Remove test files from dependencies
RUN find /usr/lib -type f -path "*/tornado/test/*" -delete 2>/dev/null || true && \
    find /usr/lib -type d -path "*/tornado/test" -delete 2>/dev/null || true

# Install semantic_router and aurelio-sdk using script
RUN chmod +x docker/install_auto_router.sh && ./docker/install_auto_router.sh

# Generate prisma client
RUN prisma generate
RUN chmod +x docker/entrypoint.sh
RUN chmod +x docker/prod_entrypoint.sh

# Create .claude directory for credentials
RUN mkdir -p /root/.claude

# Copy local config (from build context)
COPY config.yaml /app/config.yaml

EXPOSE 4000/tcp

RUN apk add --no-cache supervisor
# Copy supervisord.conf from the cloned repo (already in /app/docker/)
RUN cp /app/docker/supervisord.conf /etc/supervisord.conf

ENTRYPOINT ["docker/prod_entrypoint.sh"]
